#!/bin/bash
#$ -N Download_SRA
#$ -pe thread 8
#$ -l h_vmem=8G
#$ -t 1-3
#$ -tc 1
#$ -cwd
#$ -o logs/download_sra.$TASK_ID.out
#$ -e logs/download_sra.$TASK_ID.err

source $HOME/.bashrc
module load programs/sra-tools-3.0.0

cd $HOME/RNAseq/lncrna/waterlogging/Vradiata/lncRNAs/raw_data

SAMPLES=(
    SRR17976301
    SRR17976300
    SRR17976302
    SRR17976291
    SRR17976303
    SRR17976304
    SRR17976305
    SRR17976306
)

SAMPLE=${SAMPLES[$((SGE_TASK_ID-1))]}

# Evita que todas las tareas arranquen exactamente al mismo tiempo
sleep $((RANDOM % 30))

echo "Tarea $SGE_TASK_ID descargando $SAMPLE (NSLOTS=$NSLOTS)..."

fasterq-dump "$SAMPLE" \
    --split-files \
    --threads "$NSLOTS" \
    --outdir . \
    --progress

# Verificar y comprimir (busca CUALQUIER .fastq generado)
if ls ${SAMPLE}*.fastq 1> /dev/null 2>&1; then
    echo "  ✓ Archivos FASTQ creados"

    # Comprimir TODOS los archivos .fastq del sample
    echo "  Comprimiendo..."
    gzip -v ${SAMPLE}*.fastq

    # Verificar compresión exitosa
    if ls ${SAMPLE}*.fastq.gz 1> /dev/null 2>&1; then
        echo "  ✓ Compresión exitosa"
        echo "  ✓ $SAMPLE completado"
        echo ""
        ls -lh ${SAMPLE}*.fastq.gz
    else
        echo "  ✗ ERROR: Falló la compresión"
    fi
else
    echo "  ✗ ERROR: No se crearon archivos FASTQ"
fi

echo ""
echo "Descarga de $SAMPLE finalizada"
